os: Visual Studio 2015

platform:
  - Win32
  - x64

environment:
  global:
    PYTHON: "C:\\Python27"
    PYTHON_VERSION: "2.7.11"
    CMD_IN_ENV: "cmd /E:ON /V:ON /C .\\dist\\run_with_env.cmd"

matrix:
  fast_finish: true

install:
  - ps: >-
      If ($env:Platform -Match "Win32") {
        $env:PYTHON_ARCH="32"
        $env:CMAKE_GENERATOR="Visual Studio 14 2015"
      } Else {
        $env:PYTHON_ARCH="64"
        $env:CMAKE_GENERATOR="Visual Studio 14 2015 Win64"
      }

  # libusb patched for windows hotplug support
  - git clone https://github.com/analogdevicesinc/libusb.git "C:\libusb"

  # add python dirs to PATH
  - "SET PATH=%PYTHON%;%PYTHON%\\Scripts;%PATH%"
  # check we're using the right python version and arch
  - "python --version"
  - "python -c \"import struct; print(struct.calcsize('P') * 8)\""

  # update pip to keep it from complaining
  - "pip install --disable-pip-version-check --user --upgrade pip"
  # wheel needs to be installed in order to build binary wheels for pysmu
  - "%CMD_IN_ENV% python -m pip install wheel"

  # install innosetup for creating installers
  - choco install InnoSetup
  - set PATH=%PATH%;"C:\Program Files (x86)\Inno Setup 5"

build_script:
  # build our own libusb version with hotplug support until upstream merges related patches
  - ps: pushd "C:\libusb"
  - git checkout hotplug
  - msbuild msvc\libusb_2015.sln /p:Configuration=Release /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"
  - ps: popd

  - cmake -G "%CMAKE_GENERATOR%" \
    -DCMAKE_BUILD_TYPE:STRING=Release \
    -DCMAKE_SYSTEM_PREFIX_PATH="C:" \
    -DLIBUSB_LIBRARIES="C:\\libusb\\Win32\\Release\\lib\\libusb-1.0.lib" \
    -DLIBUSB_INCLUDE_DIRS="C:\\libusb\\libusb" \
    .
  - cmake --build . --config Release

  # create libsmu zipfile
  - mkdir c:\libsmu
  - copy src\libsmu.hpp c:\libsmu\
  - copy src\Release\libsmu.* c:\libsmu\
  - 7z a "c:\libsmu.zip" c:\libsmu
  - appveyor PushArtifact c:\libsmu.zip

  # create libsmu installer

  # build python wheel
  - "%CMD_IN_ENV% python bindings/python/setup.py bdist_wheel"
  - appveyor PushArtifact dist/*.whl

cache:
  - C:\mingw.7z -> appveyor.yml
